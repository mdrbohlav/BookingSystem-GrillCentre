extends layout

block content
    section.hero.table.table--fullsize
        .table__cell
            .hero__content
                h1.text__mainTitle.separator__after Grilovací centrum
                h2.shlogo.text__subtitle.text--white SiliconHill
    section.content
        .container__md
            .box
                .box__header.box__header--border
                    h2.text__title Kalendář rezervací
                .box__body
                    .calendar
                        script#calendar-template(type="text/template").
                            <div class="calendar__controls text--center">
                                <button class="calendar__prev text__paragraph" type="button">&lsaquo;</button>
                                <div class="calendar__current text__paragraph"><%= this.month.format('MMMM YYYY') %></div>
                                <button class="calendar__next text__paragraph" type="button">&rsaquo;</button>
                            </div>
                            <div class="calendar__grid">
                                <div class="calendar__daysWeek text--center clearfix">
                                    <% _.each(daysOfTheWeek, function(day) { %>
                                        <div class="calendar__cell day__header"><%= day %></div>
                                    <% }); %>
                                </div>
                                <div class="calendar__days clearfix">
                                <% 
                                    var lastDay = new Date();
                                    lastDay.setDate(lastDay.getDate() + #{reservationUpfront});
                                    lastDay.setHours(23, 59, 59, 999);
                                %>
                                <% _.each(days, function(day) { %>
                                    <%
                                        var dayClass = '';
                                        if (#{!user.isAdmin} && new Date(day.date.format()) > lastDay) {
                                            dayClass = 'inactive';
                                        }
                                        for (var i in day.events) {
                                            if (day.events[i].onlyMobileGrill) {
                                                day.events[i].class = 'grill';
                                            } else if (!day.events[i].mobileGrill) {
                                                day.events[i].class = 'both';
                                            } else {
                                                day.events[i].class = 'centre';
                                            }
                                        }
                                    %>
                                    <div class="calendar__cell <%= day.classes %> <%= dayClass %>">
                                        <div class="day__num"><%= day.day %></div>
                                        <% for (var i in day.events) { %>
                                            <div class="day__event <%= day.events[0].class %>">
                                            <% if (day.events[i].name.length > 20) { %>
                                                <%= day.events[i].name.substr(0, 20) %>…
                                            <% } else { %>
                                                <%= day.events[i].name %>
                                            <% } %>
                                            </div>
                                        <% } %>
                                    </div>
                                <% }); %>
                                </div>
                            </div>
                            <button class="calendar__today text__paragraph text--center" type="button">současný měsíc</button>
            .box
                .box__header.box__header--border
                    h2.text__title Nová rezervace
                .box__body
                    form#create-reservation.form.form__reservation(method='POST', action='/api/reservation/create')
                        .fieldset.row
                            if reservationLength === 1 && !user.isAdmin
                                .field__container.col-xs-12.col-sm-6.margin--top-20
                                    label.text__label(for='date') Datum
                                    .field
                                        input#date(type='text', name='date', required)
                            else
                                .field__container.col-xs-12.col-sm-6.margin--top-20
                                    label.text__label(for='date') Od
                                    .field
                                        input#date(type='text', name='date', required)
                                .field__container.col-xs-12.col-sm-6.margin--top-20
                                    label.text__label(for='date-to') Do
                                    .field
                                        input#date-to(type='text', name='date-to', required)
                            .field__container.col-xs-12.col-sm-6.margin--top-20
                                label.text__label(for='pickup') Vyzvednutí
                                .field
                                    input#pickup(type='text', name='pickup', required)
                        .switch__container
                            .fieldset
                                .text--center.margin--top-35
                                    ul.switch__list
                                        li: button.switch__trigger.active(type='button', data-res-type='centre') Gril centrum
                                        li: button.switch__trigger(type='button', data-res-type='grill') Pouze mobilní gril
                            .switch__content.fieldset.accessories
                                h3.text__subtitle.text--default Příslušenství
                                .field__checkbox
                                    span.checkbox
                                        input#mobileGrill(type='checkbox', name='mobileGrill')
                                    label.t__label(for='mobileGrill') Mobilní gril
                                each accessory, index in accessories
                                    if accessory.available
                                        .field__checkbox
                                            span.checkbox
                                                input(id='accessory-#{index}', type='checkbox', name='accessory', value= accessory.id)
                                            label.t__label(for='accessory-#{index}')= accessory.name
                        .form__footer.text--center.margin--top-40
                            button.btn.btn__orange(type='submit') Vytvořit
    section.modal.table.table--fullsize
        button.modal__close.btn__close.icon.icon__cross(type='button')
        .modal__content.table__cell
            .container__md
                .box
                    h2.text__title.box__header.box__header--border Detail dne
                    .box__body
                        .modalReservation__centre
                            h3.modalReservation__title.text__subtitle.text--default
                            .row
                                .col-xs-12.col-sm-6
                                    .modalReservation__date.text__paragraph
                                        span.text--strong Datum
                                        span.value
                                    .modalReservation__pickup.text__paragraph
                                        span.text--strong Čas vyzvednutí
                                        span.value
                                    .modalReservation__mobileGrill
                                        span.text--strong Mobilní gril
                                        span.value
                                .col-xs-12.col-sm-6
                                    h4.text__paragraph Příslušenství
                                    ul.modalReservation__accessories
                        .modalReservation__grill
                            h3.modalReservation__title.text__subtitle.text--default
                            .row
                                .col-xs-12.col-sm-6
                                    .modalReservation__date.text__paragraph
                                        span.text--strong Datum
                                        span.value
                                    .modalReservation__pickup.text__paragraph
                                        span.text--strong Čas vyzvednutí
                                        span.value

block scripts
    script.
        var reservations = {},
            users = {},
            loadedMonths = {};

        function loadReservations(calendar) {
            var tmp = calendar.month.clone();
            var date = tmp.add(tmp.local().utcOffset(), 'm'),
                startInterval = date.utc().subtract(1, 'M').format(),
                endInterval = date.utc().add(3, 'M').subtract(1, 'd').format(),
                month = date.subtract(1, 'M').month();

            if (!(month in loadedMonths)) {
                var $spinner = $('<div class="spinner--absolute"></div>');
                $spinner.append(getSpinner());
                $('.calendar').prepend($spinner);
            }

            var data = {
                from: encodeURIComponent(startInterval),
                to: encodeURIComponent(endInterval)
            };

            makeRequest('/api/reservation', 'GET', data, function(res) {
                var reservationsObj = res.reservations,
                    usersObj = res.users,
                    reservationsArr = [];
                for (var i in usersObj) {
                    if (i in users) {
                        continue;
                    }
                    users[i] = usersObj[i];
                }
                for (var i = 0; i < reservationsObj.length; i++) {
                    if (reservationsObj[i].id in reservations || ['confirmed', 'finished'].indexOf(reservationsObj[i].state) === -1) {
                        continue;
                    }
                    reservationsObj[i].from = moment(reservationsObj[i].from).add(calendar.month.local().utcOffset(), 'm').format();
                    reservationsObj[i].to = moment(reservationsObj[i].to).subtract(calendar.month.local().utcOffset(), 'm').format();
                    reservationsObj[i].name = users[reservationsObj[i].userId].fullName;
                    reservations[reservationsObj[i].id] = reservationsObj[i];
                    reservationsArr.push(reservationsObj[i]);
                }
                loadedMonths[month] = true;
                loadedMonths[moment(startInterval).month()] = true;
                loadedMonths[moment(endInterval).month()] = true;
                calendar.addEvents(reservationsArr);
            });
        }

        $(document).ready(function() {
            var $date, date, dateTo = null;

            if (#{reservationLength} > 1 || #{user.isAdmin}) {
                var $dateTo = $('#date-to').pickadate();
                dateTo = $dateTo.pickadate('picker');

                if (!#{user.isAdmin}) {
                    dateTo.set({
                        min: true,
                        max: #{reservationUpfront}
                    });
                }
                
                dateTo.on({
                    set: function(event) {
                        if (event.select) {
                            var dat = new Date(event.select),
                                MS_PER_DAY = 1000 * 60 * 60 * 24,
                                today = new Date();
                            today = today.setHours(0, 0, 0, 0);
                            today = new Date(today).getTime();
                            date.set('max', dat);
                            if (!#{user.isAdmin}) {
                                dat = event.select - #{reservationUpfront} * MS_PER_DAY <= today ? true : new Date(event.select);
                                date.set('min', dat);
                            }
                        } else if ('clear' in event) {
                            if (!#{user.isAdmin}) {
                                date.set('min', true);
                                date.set('max', #{reservationUpfront});
                            } else {
                                date.set('max', false);
                            }
                        }
                    }
                });

                $dateTo.on('change', function() {
                    $dateTo.valid();
                });

                $date = $('#date').pickadate({
                    onSet: function(event) {
                        if (event.select) {
                            var dat = new Date(event.select),
                                MS_PER_DAY = 1000 * 60 * 60 * 24,
                                today = new Date();
                            today = today.setHours(0, 0, 0, 0);
                            today = new Date(today).getTime();
                            dateTo.set('min', dat);
                            if (!#{user.isAdmin}) {
                                dat = event.select + (#{reservationLength} - 1) * MS_PER_DAY >= today + #{reservationUpfront} * MS_PER_DAY ? today + #{reservationUpfront} * MS_PER_DAY : event.select + (#{reservationLength} - 1) * MS_PER_DAY;
                                dat = new Date(dat);
                                dateTo.set('max', dat);
                            }
                        } else if ('clear' in event) {
                            if (!#{user.isAdmin}) {
                                dateTo.set('min', true);
                                dateTo.set('max', #{reservationUpfront});
                            } else {
                                dateTo.set('min', false);
                            }
                        }
                    }
                });
            } else {
                $date = $('#date').pickadate();
            }
            
            date = $date.pickadate('picker');
            if (!#{user.isAdmin}) {
                date.set({
                    min: true,
                    max: #{reservationUpfront}
                });
            }

            var $pickup = $('#pickup').pickatime({
                format: 'HH:i',
                interval: #{keyPickupInterval}
            });

            pickup = $pickup.pickatime('picker');
            if (!#{user.isAdmin}) {
                pickup.set({
                    min: [Math.floor(#{keyPickupFrom} / 60), #{keyPickupFrom} % 60],
                    max: [Math.floor(#{keyPickupTo} / 60), #{keyPickupTo} % 60]
                });
                /* / syntax highlight fix */
            }

            $date.on('change', function() {
                $date.valid();
            });

            $pickup.on('change', function() {
                $pickup.valid();
            });

            moment.locale('#{user.locale}');
            var calendar = $('.calendar').clndr({
                multiDayEvents: {
                    endDate: 'to',
                    startDate: 'from'
                },
                targets: {
                    day: 'day',
                    empty: 'empty',
                    nextButton: 'calendar__next',
                    todayButton: 'calendar__today',
                    previousButton: 'calendar__prev'
                },
                clickEvents: {
                    click: function (target) {
                        console.log(target);
                        var d = new Date(target.date.format()),
                            today = new Date(),
                            lastDay = new Date();
                        
                        today.setHours(0, 0, 0, 0);
                        lastDay.setDate(lastDay.getDate() + #{reservationUpfront});
                        lastDay.setHours(23, 59, 59, 999);

                        if (target.events.length) {
                            var dayEvents = 0;
                            for (var i = 0; i < target.events.length; i++) {
                                if (target.events[i].onlyMobileGrill) {
                                    dayEvents += 1;
                                } else if (!target.events[i].mobileGrill) {
                                    dayEvents += 2;
                                } else {
                                    dayEvents = 4;
                                }
                            }

                            if (dayEvents < 3) {
                                date.set('select', new Date(target.date.format()));
                            }

                            showModal();
                        } else if (#{user.isAdmin} || (d >= today && d <= lastDay)) {
                            date.set('select', new Date(target.date.format()));
                        }
                    },
                    nextInterval: function () {
                        console.log('Calendar next interval');
                    },
                    previousInterval: function () {
                        console.log('Calendar previous interval');
                    },
                    onIntervalChange: function () {
                        console.log('Calendar interval changed');
                    },
                    onMonthChange: function() {
                        console.log('Calendar month changed');
                        loadReservations(this);
                    }
                },
                doneRendering: function() {
                    if ($('.calendar .spinner--absolute').length) {
                        $('.calendar .spinner--absolute').remove();
                    }
                },
                template: $('#calendar-template').html(),
                showAdjacentMonths: true,
                adjacentDaysChangeMonth: true
            });

            loadReservations(calendar);

            $('[data-res-type="centre"]').on('click', function() {
                var $this = $(this);
                if ($this.hasClass('active')) {
                    return;
                }
                $('[data-res-type="grill"]').removeClass('active');
                $this.addClass('active');
                $('.accessories').velocity('finish').velocity('slideDown');
            });

            $('[data-res-type="grill"]').on('click', function() {
                var $this = $(this);
                if ($this.hasClass('active')) {
                    return;
                }
                $('[data-res-type="centre"]').removeClass('active');
                $this.addClass('active');
                $('.accessories').velocity('finish').velocity('slideUp');
            });

            $('#create-reservation').validate({
                rules: {
                    date: {
                        required: true
                    },
                    'date-to': {
                        required: function() {
                            return $('#date-to').length > 0 ? true: false;
                        }
                    },
                    pickup: {
                        required: true
                    }
                },
                errorPlacement: function() {
                    return false;
                },
                highlight: function(element, errorClass, validClass) {
                    $(element).parent().addClass('error');
                },
                unhighlight: function(element, errorClass, validClass) {
                    $(element).parent().removeClass('error');
                },
                submitHandler: function(form) {
                    var data = {};
                    var start = $('[name="date"]').pickadate('picker').get('select').pick,
                        end;
                    start = moment(new Date(start)).add(moment().utcOffset(), 'm').utc().format().replace(/\+00:00/, 'Z');
                    end = start;

                    if (#{reservationLength} > 1) {
                        end = $('[name="date-to"]').pickadate('picker').get('select').pick;
                        end = moment(new Date(end)).add(moment().utcOffset(), 'm').utc().format().replace(/\+00:00/, 'Z');
                    }
                    data.from = start;
                    data.to = end;
                    data.pickup = $('#pickup').pickatime('picker').get('select').pick;
                    data.mobileGrill = $('#mobileGrill').prop('checked');

                    if ($('[data-res-type="grill"]').hasClass('active')) {
                        data.onlymobileGrill = true;
                        data.mobileGrill = true;
                    } else {
                        data.accessories = [];
                        $('[name="accessory"]:checked').each(function(i, element) {
                            data.accessories.push($(element).val());
                        });
                    }
                    
                    var url = $(form).attr('action'),
                        method = $(form).attr('method');
                    makeRequest(url, method, data, function(res) {
                        date.clear();
                        $date.parent().removeClass('error');
                        pickup.clear();
                        $pickup.parent().removeClass('error');
                        if (dateTo) {
                            dateTo.clear();
                            $dateTo.parent().removeClass('error');
                        }
                        if ($('#mobileGrill').prop('checked')) {
                            $('#mobileGrill').trigger('click');
                        }
                        $('.accessories input[type="checkbox"]').each(function(i, element) {
                            if ($(element).prop('checked')) {
                                $(element).trigger('click');
                            }
                        });
                        addNotification('success', 'Pre-reservation successfully created.');
                    }, function(res) {
                        console.log(res);
                        var msg = res.responseJSON.error.message;
                        if (res.responseJSON.error.type === 'MaxReservationLength') {
                            msg += ' (maximum is #{reservationLength} ';
                            msg += #{reservationLength} > 1 ? 'days)' : 'day)';
                        } else if (res.responseJSON.error.type === 'MaxReservationUpfront') {
                            msg += ' (maximum is #{reservationUpfront} ';
                            msg += #{reservationUpfront} > 1 ? 'days)' : 'day)';
                        }
                        addNotification('error', msg);
                    });
                }
            });
        });
