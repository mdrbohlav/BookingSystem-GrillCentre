extends layout

block content
    section.content
        - function capitalizeFirstLetter(string) {
        -     return string.charAt(0).toUpperCase() + string.slice(1);
        - }
        - function pad(n) { 
        -     return n < 10 ? '0' + n : n; 
        - }
        .container__md
            .box
                - var draftCnt = 0
                - var today = new Date()
                - today.setUTCHours(0, 0, 0, 0)
                .box__header.box__header--border
                    h2.text__title Rezervace na schválení
                .box__body
                    .table__wrapper
                        ul#listWaitingReservations.listReservations.table.table__styled.table--fullsize.table--responsive.text--center
                            each reservation in data.reservations
                                if reservation.state === 'draft' && new Date(reservation.from) >= today
                                    - var resUser = data.users[reservation.userId]
                                    if draftCnt === 0
                                        li.table__row.table__heading
                                            .table__cell Jméno
                                            .table__cell(title='Priorita') Pr
                                            .table__cell(title='Celé grilcentrum') GC
                                            .table__cell(title='Mobilní gril') MG
                                            .table__cell Od
                                            .table__cell Do
                                            .table__cell Vyzvednutí
                                            .table__cell Akce
                                    li.reservation.table__row(data-id= reservation.id)
                                        .table__cell= resUser.fullName
                                        .table__cell= resUser.priority
                                        .table__cell: span.icon(class= (!reservation.onlyMobileGrill ? 'icon__check' : 'icon__cross'))
                                        .table__cell: span.icon(class= (reservation.mobileGrill ? 'icon__check' : 'icon__cross'))
                                        .table__cell(data-date='#{reservation.from}')
                                        .table__cell(data-date='#{reservation.to}')
                                        .table__cell #{Math.floor(reservation.pickup / 60)}:#{pad(reservation.pickup%60)}
                                        .reservation__action.table__cell
                                            button.btn__confirm.icon.icon__check(type='button', data-id= reservation.id, title='Confirm')
                                            button.btn__reject.icon.icon__cross(type='button', data-id= reservation.id, title='Reject')
                                    - draftCnt++
                            if draftCnt === 0
                                li.table__row.table__noborder
                                    .table__cell
                                        p.text__paragraph.text--center Žádné rezervace čekající na schválení
            .box
                - var finishedCnt = 0
                .box__header.box__header--border
                    h2.text__title Rezervace na ohodnocení
                .box__body
                    .table__wrapper
                        ul#listWaitingRating.listReservations.table.table__styled.table--fullsize.table--responsive.text--center
                            each reservation in data.reservations
                                if reservation.state === 'finished' && !reservation.rating
                                    - var resUser = data.users[reservation.userId]
                                    if finishedCnt === 0
                                        li.table__row.table__heading
                                            .table__cell Jméno
                                            .table__cell(title='Celé grilcentrum') GC
                                            .table__cell(title='Mobilní gril') MG
                                            .table__cell Od
                                            .table__cell Do
                                    li.reservation.table__row(data-id= reservation.id)
                                        .table__cell= resUser.fullName
                                        .table__cell: span.icon(class= (!reservation.onlyMobileGrill ? 'icon__check' : 'icon__cross'))
                                        .table__cell: span.icon(class= (reservation.mobileGrill ? 'icon__check' : 'icon__cross'))
                                        .table__cell(data-date='#{reservation.from}')
                                        .table__cell(data-date='#{reservation.to}')
                                    - finishedCnt++
                            if finishedCnt === 0
                                li.table__row.table__noborder
                                    .table__cell
                                        p.text__paragraph.text--center Žádné rezervace čekající na hodnocení
            .box
                - var resCnt = 0
                - var date = new Date()
                - var y = date.getFullYear()
                - var m = date.getMonth()
                - var lastDay = new Date(y, m + 1, 0)
                - var firstDay = new Date(y, m, 1)
                - firstDay.setUTCHours(0, 0, 0, 0)
                - lastDay.setUTCHours(23, 59, 59, 999)
                .box__header.box__header--border
                    h2.text__title Všechny rezervace (
                        span.month__selected
                        | )
                .box__body
                    .table__wrapper
                        ul#listAllReservations.listReservations.table.table__styled.table--fullsize.table--responsive.text--center
                            each reservation in data.reservations
                                if new Date(reservation.to) >= firstDay && new Date(reservation.from) <= lastDay
                                    - var resUser = data.users[reservation.userId]
                                    if resCnt === 0
                                        li.table__row.table__heading
                                            .table__cell Jméno
                                            .table__cell(title='Celé grilcentrum') GC
                                            .table__cell(title='Mobilní gril') MG
                                            .table__cell Stav
                                            .table__cell Od
                                            .table__cell Do
                                            .table__cell Hodnocení
                                    li.reservation.table__row(data-id= reservation.id)
                                        .table__cell= resUser.fullName
                                        .table__cell: span.icon(class=(!reservation.onlyMobileGrill ? 'icon__check' : 'icon__cross'))
                                        .table__cell: span.icon(class=(reservation.mobileGrill ? 'icon__check' : 'icon__cross'))
                                        .reservation__state.table__cell: span.icon(class=(reservation.state === 'draft' ? 'icon__pencil' : reservation.state === 'confirmed' ? 'icon__check' : reservation.state === 'finished' ? 'icon__flag' : 'icon__cross'), title= capitalizeFirstLetter(reservation.state))
                                        .table__cell(data-date='#{reservation.from}')
                                        .table__cell(data-date='#{reservation.to}')
                                        .resetvation__rating.table__cell= (reservation.rating ? reservation.rating.value : 'nehodnoceno')
                                    - resCnt++
                            if resCnt === 0
                                li.table__row.table__noborder
                                    .table__cell
                                        p.text__paragraph.text--center Žádné rezervace
                    .text--center.margin--top-35
                        ol.pagination
                            li: button.pagination__prev(type='button')
                                span.icon.icon__arrow-left
                                | &nbsp;
                                span.month__prev
                            li: button.pagination__item(type='button')
                                span.month__current dnes
                            li: button.pagination__next(type='button')
                                span.month__next
                                | &nbsp;
                                span.icon.icon__arrow-right
    section.modal
        .table.table--fullsize
            button.modal__close.btn__close.icon.icon__cross(type='button')
            .modal__content.table__cell
                .container__md
                    .box.modalReservation
                        h2.text__title.box__header.box__header--border Rezervace
                        .box__body
                            .row
                                .col-xs-12.col-sm-6
                                    .modalReservation__date.text__paragraph.margin--top-10
                                        span.text--strong Datum
                                        span.value
                                    .modalReservation__pickup.text__paragraph.margin--top-10
                                        span.text--strong Čas vyzvednutí
                                        span.value
                                    .modalReservation__centre.text__paragraph.margin--top-10
                                        span.text--strong Gril centrum
                                        span.value
                                    .modalReservation__mobileGrill.text__paragraph.margin--top-10
                                        span.text--strong Mobilní gril
                                        span.value
                                .col-xs-12.col-sm-6.margin--top-10
                                    h3.text__paragraph Příslušenství
                                    ul.modalReservation__accessories.text__paragraph--small
                            .modalReservation__rate.margin--top-35
                                form#rate(action='/api/admin/reservation/:id/rating', method='POST')
                                    h3.text__paragraph Hodnocení
                                    .fieldset.row
                                        .field__container.col-xs-12.col-sm-3.margin--top-10
                                            label.text__label Hodnota
                                            .field.rating__field
                                                .rating
                                                    input#rating-input-1-5.input--default.rating__input(type="radio", name="rating-input-1")
                                                    label.rating__star(for="rating-input-1-5")
                                                    input#rating-input-1-4.input--default.rating__input(type="radio", name="rating-input-1")
                                                    label.rating__star(for="rating-input-1-4")
                                                    input#rating-input-1-3.input--default.rating__input(type="radio", name="rating-input-1")
                                                    label.rating__star(for="rating-input-1-3")
                                                    input#rating-input-1-2.input--default.rating__input(type="radio", name="rating-input-1")
                                                    label.rating__star(for="rating-input-1-2")
                                                    input#rating-input-1-1.input--default.rating__input(type="radio", name="rating-input-1")
                                                    label.rating__star(for="rating-input-1-1")
                                        .field__container.col-xs-12.col-sm-9.margin--top-10
                                            label.text__label(for='rateComment') Komentář
                                            .field
                                                input#rateComment(type='text', name='rateComment')
                                    .form__footer.text--center.margin--top-25
                                        button.btn.btn__orange(type='submit') Hodnotit
                    .box.modalUser
                        h2.text__title.box__header.box__header--border Uživatel
                        .box__body
                            h3.modalUser__title.text__subtitle.text--default
                            .row
                                .col-xs-12.col-sm-6
                                    .modalUser__admin.text__paragraph.margin--top-10
                                        span.text--strong Admin
                                        span.value
                                    .modalUser__email.text__paragraph.margin--top-10
                                        span.text--strong Email
                                        span.value
                                    .modalUser__cell.text__paragraph.margin--top-10
                                        span.text--strong Blok/pokoj
                                        span.value
                                .col-xs-12.col-sm-6
                                    .modalUser__ban.text__paragraph.margin--top-10
                                        span.text--strong Ban
                                        span.value
                                        button.ban.btn.btn__orange.btn--small(data-type='button') udělit
                                        button.unban.btn.btn__orange.btn--small(data-type='button') odebrat
                                    .modalUser__isid.text__paragraph.margin--top-10
                                        span.text--strong IS Id
                                        span.value
                                    .modalUser__locale.text__paragraph.margin--top-10
                                        span.text--strong Jazyk
                                        span.value
                            .modalUser__rating
                                h4.text__subtitle.margin--top-35 Všechan hodnocení
                                ul#listRating.table
                                    li.table__row.table__noborder
                                        .table__cell
                                            p.text__paragraph.text--center Žádné hodnocení

block scripts
    script.
        var reservations = !{JSON.stringify(data.reservations)},
            users = !{JSON.stringify(data.users)},
            tmp = {};
        for (var i = 0; i < reservations.length; i++) {
            tmp[reservations[i].id] = reservations[i];
        }
        reservations = tmp;
    
        function getReservationsTableHeading() {
            return $('<li class="table__row table__heading">')
                .append('<div class="table__cell">Jméno')
                .append('<div class="table__cell" title="Priorita">Pr')
                .append('<div class="table__cell" title="Celé grilcentrum">GC')
                .append('<div class="table__cell" title="Mobilní gril">MB')
                .append('<div class="table__cell">Stav')
                .append('<div class="table__cell">Od')
                .append('<div class="table__cell">Do');
        }

        function getReservationRow(reservation, user) {
            var tmp = moment(),
                start = moment(reservation.from).subtract(tmp.local().utcOffset(), 'm'),
                end = moment(reservation.to).subtract(tmp.local().utcOffset(), 'm');
            return $('<li class="reservation table__row" data-id="' + reservation.id + '">')
                .append('<div class="table__cell">' + user.fullName)
                .append('<div class="table__cell">' + user.priority)
                .append('<div class="table__cell"><span class="icon icon__' + (!reservation.onlyMobileGrill ? 'check' : 'cross') + '">')
                .append('<div class="table__cell"><span class="icon icon__' + (reservation.mobileGrill ? 'check' : 'cross') + '">')
                .append('<div class="reservation__state table__cell"><span class="icon icon__' + (reservation.state === 'draft' ? 'pencil' : reservation.state === 'confirmed' ? 'check' : reservation.state === 'finished' ? 'flag' : 'cross') + '" title="' + capitalizeFirstLetter(reservation.state) + '">')
                .append('<div class="table__cell" data-date="' + reservation.from + '">' + start.format('LL'))
                .append('<div class="table__cell" data-date="' + reservation.to + '">' + end.format('LL'));
        }

        function getReservationsEmptyRow() {
            return $('<li class="table__row table__noborder">')
                .append($('<div class="table__cell">')
                    .append('<p class="text__paragraph text--center">Žádné rezervace'));
        }

        function getRatingTableHeading() {
            return $('<li class="table__row table__heading">')
                .append('<div class="table__cell">Od')
                .append('<div class="table__cell">Do')
                .append('<div class="table__cell" title="Celé grilcentrum">GC')
                .append('<div class="table__cell" title="Mobilní gril">MB')
                .append('<div class="table__cell">Hodnocení');
        }

        function getRatingRow(reservation) {
            var tmp = moment(),
                start = moment(reservation.from).subtract(tmp.local().utcOffset(), 'm'),
                end = moment(reservation.to).subtract(tmp.local().utcOffset(), 'm');
            return $('<li class="reservation table__row" data-id="' + reservation.id + '">')
                .append('<div class="table__cell" data-date="' + reservation.from + '">' + start.format('LL'))
                .append('<div class="table__cell" data-date="' + reservation.to + '">' + end.format('LL'))
                .append('<div class="table__cell"><span class="icon icon__' + (!reservation.onlyMobileGrill ? 'check' : 'cross') + '">')
                .append('<div class="table__cell"><span class="icon icon__' + (reservation.mobileGrill ? 'check' : 'cross') + '">')
                .append('<div class="table__cell">' + reservation.rating.value);
        }

        function getRatingEmptyRow() {
            return $('<li class="table__row table__noborder">')
                .append($('<div class="table__cell">')
                    .append('<p class="text__paragraph text--center">Žádné hodnocení'));
        }

        $(document).ready(function() {
            moment.locale('#{user.locale}');

            $('[data-date]').each(function(i, element) {
                var tmp = moment(),
                    date = moment($(element).attr('data-date')).subtract(tmp.local().utcOffset(), 'm');
                $(element).text(date.format('LL'));
            });

            var month = moment();
            $('.month__current').attr('data-month', month.valueOf());
            $('.month__selected').text(month.format('MMMM')).attr('data-month', month.valueOf());
            $('.month__prev').text(month.subtract(1, 'months').format('MMMM')).attr('data-month', month.valueOf());
            $('.month__next').text(month.add(2, 'months').format('MMMM')).attr('data-month', month.valueOf());

            $('.pagination button').on('click', function() {
                var $this = $(this),
                    $children = $this.find('[class^="month__"]'),
                    val = $children.attr('data-month'),
                    $list = $('#listAllReservations'),
                    $spinner = $('<div class="spinner--absolute"></div>').append(getSpinner());

                $list.append($spinner);

                makeRequest('/admin/reservations?accept=json&month=' + val, 'GET', {}, function(res) {
                    var month = moment(parseInt(val));
                    $('.month__selected').text(month.format('MMMM')).attr('data-month', month.valueOf());
                    $('.month__prev').text(month.subtract(1, 'months').format('MMMM')).attr('data-month', month.valueOf());
                    $('.month__next').text(month.add(2, 'months').format('MMMM')).attr('data-month', month.valueOf());

                    if (res.total > 0) {
                        $list.html(getReservationsTableHeading());
                        for (var i = 0; i <  res.reservations.length; i++) {
                            $list.append(getReservationRow(res.reservations[i], res.users[res.reservations[i].userId]));
                            if (!(res.reservations[i].id in reservations)) {
                                reservations[res.reservations[i].id] = res.reservations[i];
                            }
                        }
                        for (var k in res.users) {
                            if (k in users) {
                                continue;
                            }
                            users[k] = res.users[k];
                        }
                    } else {
                        $list.html(getReservationsEmptyRow());
                    }
                });
            });

            $('.btn__confirm').on('click', function() {
                var $this = $(this),
                    $row = $this.closest('.table__row'),
                    id = $this.attr('data-id');

                makeRequest('/api/admin/reservation/' + id + '/confirm', 'PUT', {}, function(res) {
                    addNotification('success', 'Reservation successfully confirmed.');
                    $row.remove();
                    if ($('#listWaitingReservations li:not(.table__heading)').length === 0) {
                        $('#listWaitingReservations').html('<li class="table__row table__noborder"><div class="table__cell"><p class="text__paragraph text--center">Žádné rezervace čekající na schválení</p></div></li>');
                    }

                    var $reservationRow = $('.reservation[data-id="' + id + '"]');
                    if ($reservationRow.length) {
                        $reservationRow.find('.reservation__state span').removeClass('icon__pencil').addClass('icon__check').attr('title', 'Confirmed');
                    }
                }, function(res) {
                    console.log(res);
                    if (res instanceof Array) {
                        for (var i = 0; i < res.length; i++) {
                            addNotification('error', res[i].message);
                        }
                    } else {
                        var msg = res.responseJSON.error.message;
                        addNotification('error', msg);
                    }
                });
            });

            $('.btn__reject').on('click', function() {
                var $this = $(this),
                    $row = $this.closest('.table__row'),
                    id = $this.attr('data-id');

                makeRequest('/api/admin/reservation/' + id + '/reject', 'PUT', {}, function(res) {
                    addNotification('success', 'Reservation successfully rejected.');
                    $row.remove();
                    if ($('#listWaitingReservations li:not(.table__heading)').length === 0) {
                        $('#listWaitingReservations').html('<li class="table__row table__noborder"><div class="table__cell"><p class="text__paragraph text--center">Žádné rezervace čekající na schválení</p></div></li>');
                    }

                    var $reservationRow = $('.reservation[data-id="' + id + '"]');
                    if ($reservationRow.length) {
                        $reservationRow.find('.reservation__state span').removeClass('icon__pencil').addClass('icon__cross').attr('title', 'Rejected');
                    }
                }, function(res) {
                    console.log(res);
                    if (res instanceof Array) {
                        for (var i = 0; i < res.length; i++) {
                            addNotification('error', res[i].message);
                        }
                    } else {
                        var msg = res.responseJSON.error.message;
                        addNotification('error', msg);
                    }
                });
            });

            $('.modalUser__ban .ban').on('click', function() {
                var $this = $(this),
                    $user = $this.closest('.modalUser'),
                    id = $user.attr('data-id'),
                    $state = $user.find('.modalUser__ban .value'),
                    $unban = $this.next(),
                    data = {
                        banned: true
                    };

                makeRequest('/api/admin/user/' + id, 'PUT', data, function(res) {
                    addNotification('success', 'User ‘' + users[id].fullName + '’ successfully banned.');
                    $this.hide();
                    $unban.show();
                    $state.text('ano');
                }, function(res) {
                    console.log(res);
                    if (res instanceof Array) {
                        for (var i = 0; i < res.length; i++) {
                            addNotification('error', res[i].message);
                        }
                    } else {
                        var msg = res.responseJSON.error.message;
                        addNotification('error', msg);
                    }
                });
            });

            $('.modalUser__ban .unban').on('click', function() {
                var $this = $(this),
                    $user = $this.closest('.modalUser'),
                    id = $user.attr('data-id'),
                    $state = $user.find('.modalUser__ban .value'),
                    $ban = $this.prev(),
                    data = {
                        banned: false
                    };

                makeRequest('/api/admin/user/' + id, 'PUT', data, function(res) {
                    addNotification('success', 'User ‘' + users[id].fullName + '’ successfully unbanned.');
                    $this.hide();
                    $ban.show();
                    $state.text('ne');
                }, function(res) {
                    console.log(res);
                    if (res instanceof Array) {
                        for (var i = 0; i < res.length; i++) {
                            addNotification('error', res[i].message);
                        }
                    } else {
                        var msg = res.responseJSON.error.message;
                        addNotification('error', msg);
                    }
                });
            });

            $('.reservation[data-id]').on('click', function(event) {
                var $row = $(this),
                    id = $row.attr('data-id'),
                    ignore = $row.find('button').toArray();
                if (ignore.indexOf(event.target) > -1) {
                    return;
                }
                var tmp = moment();
                var start = moment(reservations[id].from).subtract(tmp.local().utcOffset() , 'm').format('LL'),
                    end = moment(reservations[id].to).subtract(tmp.local().utcOffset() , 'm').format('LL'),
                    resDate = start;
                if (start !== end) {
                    resDate += ' - ' + end;
                }
                
                $('.modalReservation__date .value').text(resDate);
                $('.modalReservation__pickup .value').text(Math.floor(reservations[id].pickup / 60) + ':' + pad(reservations[id].pickup % 60));
                $('.modalReservation__centre .value').text((reservations[id].onlyMobileGrill ? 'ne' : 'ano'));
                $('.modalReservation__mobileGrill .value').text((reservations[id].mobileGrill ? 'ano' : 'ne'));
                $('.modalReservation__accessories').html('');
                if (reservations[id].accessories.length === 0) {
                    $('.modalReservation__accessories').append('<li>žádné</li>');
                } else {
                    for (var j = 0; j < reservations[id].accessories.length; j++) {
                        $('.modalReservation__accessories').append('<li>' + reservations[id].accessories[j].name + '</li>');
                    }
                }
                $('.modalUser').attr('data-id', reservations[id].userId);
                $('.modalUser__title').text(users[reservations[id].userId].fullName);
                $('.modalUser__admin .value').text((users[reservations[id].userId].isAdmin ? 'ano' : 'ne'));
                $('.modalUser__email .value').html('<a href="mailto:' + users[reservations[id].userId].email + '">' + users[reservations[id].userId].email + '</a>');
                if (users[reservations[id].userId].block && users[reservations[id].userId].room) {
                    $('.modalUser__cell').show();
                    $('.modalUser__cell .value').text(users[reservations[id].userId].block + '/' + users[reservations[id].userId].room);
                } else {
                    $('.modalUser__cell').hide();
                }
                $('.modalUser__ban .value').text((users[reservations[id].userId].banned ? 'ano' : 'ne'));
                if (users[reservations[id].userId].banned) {
                    $('.modalUser__ban .ban').hide();
                    $('.modalUser__ban .unban').show();
                } else {
                    $('.modalUser__ban .ban').show();
                    $('.modalUser__ban .unban').hide();
                }
                if (users[reservations[id].userId].isId) {
                    $('.modalUser__isid').show();
                    $('.modalUser__isid .value').html('<a href="https://is.sh.cvut.cz/users/' + users[reservations[id].userId].isId + '" target="_blank">' + users[reservations[id].userId].isId + '</a>');
                } else {
                    $('.modalUser__isid').hide();
                }
                var locale = Object.keys(users[reservations[id].userId].locale)[0];
                if ('#{Object.keys(user.locale)[0]}' === locale) {
                    $('.modalUser__locale .value').text(users[reservations[id].userId].locale[locale].nativeName);
                } else {
                    $('.modalUser__locale .value').text(users[reservations[id].userId].locale[locale].name);
                }

                var $list = $('#listRating');
                $list.html(getRatingEmptyRow());

                showModal();

                var $spinner = $('<div class="spinner--absolute"></div>').append(getSpinner());
                $list.append($spinner);
                makeRequest('/api/admin/user/' + id + '/reservations', 'GET', {}, function(res) {
                    if (res.total > 0) {
                        for (var i = 0; i <  res.reservations.length; i++) {
                            if (!res.reservations[i].rating) {
                                continue;
                            }
                            if ($list.find('li:not(.table__heading)').length === 1) {
                                $list.html(getRatingTableHeading());
                            }
                            $list.append(getRatingRow(res.reservations[i]));
                        }
                    }
                    if ($list.find('li:not(.table__heading)').length === 1) {
                        $spinner.remove();
                    }
                });
            });
        });
